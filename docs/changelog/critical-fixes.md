# Critical Fixes Summary

This document contains all high-severity security and data corruption bugs found during the February 2026 comprehensive protocol audit.

**Total:** 24 protocols with critical fixes

## Critical (Security / Data Corruption)

| Protocol | File | Fix |
|----------|------|-----|
| TeamSpeak | `teamspeak.ts` | **RESOURCE LEAK**: Fixed timeout handles never cleared — `setTimeout()` in `readTSResponse()`, `readTSBanner()`, `tsSession()`, and all handler functions now use `timeoutHandle` variable with `clearTimeout()` in finally blocks; **DATA CORRUPTION**: Fixed unescape order — `\\` now processed last to prevent false matches (e.g., `\\s` → `\s` instead of space); **SECURITY**: Fixed `serverAdminToken` sent unescaped on line 636 — now uses `tsEscape()` to prevent command injection from tokens containing spaces/pipes/backslashes; **PROTOCOL VIOLATION**: Fixed line terminator regex from `/\n\r\n$/` to `/\r\n$/` (TeamSpeak uses CR LF, not LF CR LF); **INPUT VALIDATION**: Added timeout bounds check (1-300000ms) to all 6 endpoints |
| RADSEC | `radsec.ts` | **RFC 6614 VIOLATION**: Added User-Password encryption with shared secret "radsec" (was cleartext); added Response Authenticator validation (RFC 2865 §3); added Message-Authenticator HMAC-MD5 (RFC 3579 §3.2); fixed Accounting-Request Authenticator (RFC 2866 §3); replaced Math.random() with crypto.getRandomValues() for Request Authenticator/Identifier |
| SCP | `scp.ts` | Fixed command injection in shell paths; fixed base64 encoding corruption; fixed protocol flow (server sends ready first); added filename path traversal protection; added timestamp handling; fixed file content reading to exact byte count |
| XMPP | `xmpp.ts` | Added XML entity escaping for domain, recipient JID, and message body to prevent XML injection |
| WinRM | `winrm.ts` | Added XML entity escaping for username, password, command, and shell ID; replaced string-based chunked TE decoder with byte-level `decodeChunkedBytes()` for correct multi-byte character handling |
| SMTP | `smtp.ts` | Added dot-stuffing in `DATA` payload — lines starting with `.` are escaped to `..` per RFC 5321 §4.5.2 |
| NNTP/NNTPS | `nntp.ts`, `nntps.ts` | Added dot-stuffing for article bodies in POST command |
| LMTP | `lmtp.ts` | Fixed dot-stuffing regex to handle first line — was using `/\r\n\./g` which misses message bodies starting with `.` per RFC 5321 §4.5.2 |
| POP3 | `pop3.ts` | Added dot-unstuffing when parsing multi-line responses — lines starting with `..` are decoded to `.` |
| PostgreSQL | `postgres.ts` | **RESOURCE LEAK**: Fixed timeout handles not cleared in 5 endpoints (connect, query, describe, listen, notify) — added `clearTimeout()` in finally blocks; **SECURITY**: Added message length validation (4 bytes to 1GB) to prevent OOM attacks; **DATA CORRUPTION**: Fixed ParameterStatus parsing to validate NUL terminators exist before slicing (was accessing out-of-bounds on malformed messages); **SECURITY**: Replaced SQL string interpolation with dollar-quoted strings in NOTIFY handler to prevent SQL injection; **RFC VIOLATION**: Added SCRAM-SHA-256 mechanism verification — now checks server advertises SCRAM-SHA-256 before proceeding (was assuming support) |
| iSCSI | `iscsi.ts` | Fixed `ExpStatSN` to echo received `StatSN` from responses instead of staying at 0 |
| SIPS | `sips.ts` | Fixed digest auth URI scheme from `sip:` to `sips:` per RFC 3261; cleaned up unused credentials warning; fixed REGISTER error handling |
| SIP | `sip.ts` | **RESOURCE LEAK**: Fixed timeout handles not cleared in 3 endpoints (OPTIONS, REGISTER, Digest Auth) — replaced `timeoutPromise` with `timeoutHandle` and added `clearTimeout()` in finally blocks; **RESOURCE LEAK**: Fixed reader/writer locks not released in error paths — wrapped all cleanup in try/finally with exception suppression; **BUG**: Fixed duplicate socket.close() calls (was called in catch block after try block) — moved to finally block only; **DATA CORRUPTION**: Fixed Content-Length byte counting for multi-byte UTF-8 in response bodies — was using character length instead of byte length for body comparison; **PROTOCOL VIOLATION**: Added rport parameter to Via headers in all requests for NAT traversal per RFC 3581; **RFC VIOLATION**: Added Contact header to OPTIONS requests per RFC 3261 §11.1 recommendations; **SECURITY**: Added Content-Length validation to reject negative or oversized values (was accepting any parsed integer); **INPUT VALIDATION**: Added timeout bounds validation (1000-300000ms) to all endpoints; **BUG**: Fixed early returns in readSipResponse not clearing timeout handles |
| Mumble | `mumble.ts` | Fixed protobuf varint parsing integer overflow (signed bitwise OR → unsigned `>>> 0`); fixed frame header parsing overflow; fixed varint encoding for values > 2³² (`>>>= 7` → `Math.floor(value/128)`); added Ping timestamp field for RTT measurement; added version_v2 field parsing |
| NSQ | `nsq.ts` | Fixed data corruption in subscribe handler — was using text-decoded `frame.data` instead of raw bytes `frame.rawData` for binary FrameTypeMessage parsing, corrupting 8-byte timestamp and 2-byte attempts fields; fixed subscribe to use `parseNSQMessage()` helper instead of manual charCodeAt extraction |
| NBD | `nbd.ts` | Fixed `readExact()` buffer overshoot — now returns exactly `needed` bytes instead of all accumulated chunks; added 1MB limit on option reply data length to prevent memory exhaustion attacks; added handle validation in read/write responses per RFC 7143 §2.6.2; added timeout cleanup with `clearTimeout()` on all code paths; added offset non-negative validation; added hex string character validation before parsing; fixed hex dump ASCII sidebar range (`<= 0x7e` instead of `< 0x7f`) |
| NSCA | `nsca.ts` | **PROTOCOL VIOLATION**: Added 2-byte padding after return_code field (offset 14-16) to align host_name at offset 16 per NSCA v3 spec; **SECURITY**: Added timeout cleanup with clearTimeout() in all code paths to prevent resource leaks; **SECURITY**: Added MAX_CHUNKS=100 limit to prevent memory exhaustion from malicious servers; **DATA CORRUPTION**: Made all DataView byte order explicit (big-endian) with false parameter; **BUG**: Fixed reader/writer lock cleanup in early return paths using try/finally; **BUG**: Fixed DataView timestamp parsing to use byteOffset for correct subarray handling; **BUG**: Fixed error response cipher mismatch in /encrypted endpoint to extract actual cipher from request |
| OpenTSDB | `opentsdb.ts` | **RESOURCE LEAK**: Fixed error path cleanup — wrapped `reader.releaseLock()`, `writer.releaseLock()`, and `socket.close()` in try-catch to prevent exceptions during cleanup from leaking connections; **SECURITY**: Added Cloudflare detection to `/query` endpoint (was missing); **INPUT VALIDATION**: Added `max` parameter bounds check (1-25000) in `/suggest`; added metric name length limit (255 bytes); added tag count limit (max 8 tags per data point); added tag key/value length limits (255 bytes each); added timestamp safe integer validation; added host format validation and port range check (1-65535) in `/query` endpoint |
| PCEP | `pcep.ts` | **RESOURCE LEAK**: Fixed `readExact()` timeout not cleared — replaced `timeoutPromise` with `timeoutHandle` and added `clearTimeout()` in all `finally` blocks; **DATA CORRUPTION**: Fixed `readExact()` buffer overshoot — now returns exactly `needed` bytes instead of all accumulated chunks; **PROTOCOL VIOLATION**: Fixed TLV padding calculation — was using padded value length as full offset instead of adding to 4-byte header; **PROTOCOL VIOLATION**: Fixed object padding in PCRep parsing — now pads to 4-byte boundary per RFC 5440 §7.2; **SECURITY**: Added object length bounds check (reject objLen > 65535) to prevent buffer overread; **INPUT VALIDATION**: Added IPv4 octet validation (0-255 range check); added port validation (1-65535) to `/probe` endpoint |
| RCON | `rcon.ts` | **RESOURCE LEAK**: Fixed timeout handles not cleared — replaced `timeoutPromise` with `timeoutHandle` and added `clearTimeout()` in finally blocks for both endpoints; **RESOURCE LEAK**: Fixed reader/writer locks not released in error paths — wrapped cleanup in try/finally with exception suppression; **RESOURCE LEAK**: Fixed `readFromSocket()` short timeout (200ms) not cleared after data collection; **SECURITY**: Added packet size validation (reject size < 10 or > 4096 bytes) to prevent memory exhaustion; **SECURITY**: Added 1MB memory limit in `readFromSocket()` to prevent DoS from infinite data; **PROTOCOL VIOLATION**: Added packet type validation (reject invalid types); **PROTOCOL VIOLATION**: Added request ID validation — auth and command responses must match request ID or be -1 (auth failure); **DATA CORRUPTION**: Fixed body length negative value handling (was using Math.max(0, bodyLength), now rejects packet); **BUG**: Fixed socket.close() called multiple times (moved to finally block only); **BUG**: Fixed empty response edge case (throw error on connection closed before data); **INPUT VALIDATION**: Fixed command length limit from 1446 to 4082 bytes (actual RCON protocol max) |
| PJLink | `pjlink.ts` | **RESOURCE LEAK**: Fixed timeout handles never cleared — both `timeoutPromise` and `globalTimeout` used `setTimeout()` but never called `clearTimeout()`; **DUPLICATE TIMEOUT**: Removed redundant timeout logic (two timers racing per request); **AUTHENTICATION BUG**: Fixed premature `authenticated = true` before server validation — now based on first command response; **LOCK CLEANUP**: Fixed double-release on early return when password missing — wrapped all lock releases in try-catch; **COMMAND FORMAT**: Fixed inconsistent `\r` append-then-strip pattern; **MD5 OPTIMIZATION**: Removed unnecessary `new Uint8Array(data)` wrapper; **INPUT VALIDATION**: Added empty host check and timeout bounds (1-300000ms); **ERROR HANDLING**: Fixed ERRA not distinguishing auth failure from unsupported command |
| Sonic | `sonic.ts` | **RESOURCE LEAK**: Fixed timeout handles not cleared in 5 endpoints (probe, query, push, suggest, ping) — replaced `timeoutPromise` with `timeoutHandle` and added `clearTimeout()` in finally blocks; **DUPLICATE TIMEOUT**: Removed dual racing timeouts in probe/ping — was creating two `setTimeout()` calls per request; **RESOURCE LEAK**: Fixed reader/writer locks not released in error paths — wrapped all cleanup in try/finally with exception suppression; **DATA CORRUPTION**: Fixed `readLine()` buffer overflow — was accumulating chunks beyond `maxBytes` before checking terminator; **PROTOCOL VIOLATION**: Fixed INFO response parsing to strip `RESULT ` prefix before extracting `key(value)` pairs; **PROTOCOL VIOLATION**: Added QUIT response validation (`ENDED quit` expected); **BUG**: Fixed modes detection in probe — now tests all three modes (control, search, ingest) via separate connections and populates `modes` object; **INPUT VALIDATION**: Added timeout bounds (1-60000ms) to all endpoints; **INPUT VALIDATION**: Added collection/bucket/objectId validation (alphanumeric/underscore/hyphen only, max 64 chars); **SECURITY**: Added Cloudflare detection to query/push/suggest endpoints (was missing); **INPUT VALIDATION**: Added port validation (1-65535) to query/push/suggest; **BUG**: Fixed quote escaping to escape backslashes first (`replace(/\\/g, '\\\\').replace(/"/g, '\\"')`) — was allowing `\"` to become `\\"` which unescapes to `\`; **BUG**: Added ERR response handling in query/suggest to throw descriptive error instead of returning empty results |
| Sentinel | `sentinel.ts` | **RESOURCE LEAK**: Fixed timeout handles never cleared in `readRESPFull()` — replaced `timeoutPromise` with `timeoutHandle` and added `clearTimeout()` in finally block; **RESOURCE LEAK**: Fixed reader/writer locks not released in error paths — wrapped cleanup in try/finally with exception suppression for all 4 endpoints plus `sentinelWriteCommand` helper; **DATA CORRUPTION**: Fixed TextDecoder stream never finalized — now calls `decoder.decode(new Uint8Array(0), { stream: false })` before returning to flush multi-byte UTF-8 sequences; **PROTOCOL VIOLATION**: Fixed integer parsing without NaN validation in `parseRESP()` and `readRESPFull()` — now validates all `parseInt()` results; **PROTOCOL VIOLATION**: Fixed missing RESP type validation — now checks first character against `[+\-:$*]` and throws on invalid input; **SECURITY**: Added masterName validation against `[a-zA-Z0-9_-]+` pattern in all endpoints accepting masterName; **SECURITY**: Added Cloudflare detection (`.workers.dev` or `cloudflare` in hostname) returning 403 with `isCloudflare: true`; **BUG**: Fixed empty password treated as "no password" — changed `if (password)` to `if (password !== undefined)`; **EDGE CASE**: Added warning when `flatArrayToObject()` receives odd-length array (last element dropped); **PROTOCOL VIOLATION**: Improved array completion heuristic from `buffer.length > 4096` early return to conservative line-count check (`1 + count * 4` for nested arrays) |
| Rserve | `rserve.ts` | **RESOURCE LEAK**: Fixed timeout handles not cleared — replaced `timeoutPromise` with `timeoutHandle` and added `clearTimeout()` in all finally blocks for both endpoints; **RESOURCE LEAK**: Fixed reader/writer locks not released in error paths — wrapped all cleanup in try/finally with exception suppression; **RESOURCE LEAK**: Fixed `readResponse()` timeout handle never cleared on each iteration; **BUG**: Fixed socket.close() called multiple times (moved to finally block only); **DATA CORRUPTION**: Fixed `buildDTString()` padding calculation — replaced confusing formula with explicit remainder check; **PROTOCOL VIOLATION**: Fixed redundant conditional in `parseQAP1Response()` — was returning `cmd: isResponse ? cmd : cmd`; **DATA CORRUPTION**: Fixed attribute SEXP bounds validation — now rejects attributes that exceed parent SEXP length to prevent out-of-bounds reads; **INPUT VALIDATION**: Added empty host check to both endpoints; **INPUT VALIDATION**: Added timeout bounds validation (1-300000ms) to both endpoints |
| UUCP | `uucp.ts` | **RESOURCE LEAK**: Fixed timeout handles not cleared in both endpoints — replaced `timeoutPromise` with `timeoutHandle` and added `clearTimeout()` in finally blocks; **RESOURCE LEAK**: Fixed reader/writer locks not released in error paths — wrapped all cleanup in try/finally with exception suppression; **BUG**: Fixed duplicate `socket.close()` calls — moved to finally block only; **INPUT VALIDATION**: Added timeout bounds validation (1000-300000ms) to both endpoints; **INPUT VALIDATION**: Added port validation (1-65535) to `/api/uucp/handshake` (was missing); **PROTOCOL VIOLATION**: Fixed system name character validation — removed underscore from allowed chars (traditional UUCP uses alphanumeric + hyphen only); **SECURITY**: Fixed unsafe regex on binary data — run login detection on sanitized `displayBanner` instead of raw `rawText`; **BUG**: Fixed DLE+S protocol detection buffer overrun — added length check (`rawBytes.length >= 2`) before accessing second byte |

## Common Patterns

**Resource Leaks (24 protocols):**
- Timeout handles never cleared with `clearTimeout()`
- Reader/writer locks not released in error paths
- Socket cleanup missing in timeout/error cases

**Security Vulnerabilities (18 protocols):**
- XML/command/SQL injection from unescaped user input
- Missing input validation (lengths, bounds, character sets)
- Weak crypto (Math.random() instead of crypto.getRandomValues())
- Missing Cloudflare detection (SSRF prevention)

**Data Corruption (16 protocols):**
- Multi-byte UTF-8 handling issues
- Buffer overflow/underflow in binary parsing
- Integer overflow in bitwise operations
- Incorrect byte vs character length calculations

**Protocol Violations (15 protocols):**
- RFC non-compliance in message formats
- Missing required fields or headers
- Incorrect parsing of wire format structures
- Improper state machine handling

## See Also

- [Medium Fixes Summary](medium-fixes.md) - All medium-severity bugs
- [2026-02-18 Protocol Review Project](2026-02-18-protocol-review.md) - Comprehensive review overview
- [By Protocol Changelog](by-protocol/README.md) - Individual protocol bug details
