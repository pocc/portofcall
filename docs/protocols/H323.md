# H.323 — Power User Reference

**Port:** 1720 (TCP) | **Protocol:** H.225/Q.931 + H.245 | **Rating:** ★★★★★

Port of Call provides four H.323 endpoints: a full Q.931 call signaling probe with multi-message loop, a gatekeeper registration probe, a lightweight port/service info check, and an H.245 capability exchange. All four open a direct TCP connection from the Cloudflare Worker. No TLS, no TPKT framing, no Cloudflare detection.

---

## API Endpoints

### `POST /api/h323/connect` — Full call signaling probe

Sends a Q.931 SETUP, then loops reading responses (CALL PROCEEDING, ALERTING, PROGRESS, FACILITY) until a final message (CONNECT, RELEASE COMPLETE, STATUS, or unknown type) arrives or the read window expires. On CONNECT, sends RELEASE COMPLETE to tear down. On intermediate-only responses (no final), also sends RELEASE COMPLETE.

**POST body:**

| Field | Type | Default | Notes |
|---|---|---|---|
| `host` | string | *(required)* | Target H.323 endpoint |
| `port` | number | `1720` | |
| `callingNumber` | string | `"1000"` | Digits, `*`, `#`, `+` only |
| `calledNumber` | string | `"2000"` | Digits, `*`, `#`, `+` only |
| `timeout` | number | `10000` | Capped at 30000 ms |

**Response:**

```json
{
  "success": true,
  "host": "pbx.example.com",
  "port": 1720,
  "callingNumber": "1000",
  "calledNumber": "2000",
  "status": "release_complete",
  "messages": [
    { "type": "q931", "messageType": 2, "messageTypeName": "CALL PROCEEDING", "ieCount": 3, "timestamp": 42 },
    { "type": "q931", "messageType": 90, "messageTypeName": "RELEASE COMPLETE", "cause": { "value": 16, "description": "Normal call clearing" }, "ieCount": 2, "timestamp": 85 }
  ],
  "protocol": "H.225/Q.931",
  "protocolVersion": "H.323v4",
  "connectTime": 18,
  "rtt": 85
}
```

**`status` values:** `no_response`, `call_proceeding`, `alerting`, `progress`, `facility`, `connected`, `release_complete`, `status`, `unknown_response`.

**Timing:** Per-read timeout is 3 s. Max read window is `min(timeout - connectTime, 8000)` ms — so even with `timeout=30000`, the read phase caps at 8 s.

---

### `POST /api/h323/register` — Gatekeeper registration probe

Sends a Q.931 SETUP with an H.225 User-User IE stub (H.225 v4 protocol identifier OID). Reads a single response and extracts H.225 version from the UUIE and Connected Number from IE 0x4C.

**POST body:**

| Field | Type | Default | Notes |
|---|---|---|---|
| `host` | string | *(required)* | |
| `port` | number | `1720` | |
| `calledNumber` | string | `"100"` | **Different default from /connect** |
| `callingNumber` | string | `"200"` | **Different default from /connect** |
| `timeout` | number | `10000` | Capped at 30000 ms |

**Response:**

```json
{
  "success": true,
  "messageType": 90,
  "messageTypeName": "RELEASE COMPLETE",
  "h225Version": "H.225 v4",
  "destinationAddress": "1234",
  "latencyMs": 47,
  "raw": [8, 2, 128, 1, 90, ...],
  "cause": { "value": 16, "description": "Normal call clearing" },
  "display": "Not in service"
}
```

**`raw`** is the first 64 bytes of the response as a number array.

**`h225Version`** is derived from byte offset [5] of the User-User IE data, after confirming byte [0] is `0x05` (H.323 UU protocol discriminator). If the UUIE is absent or too short (<7 bytes), returns `"Unknown"`.

**`success` semantics:** `false` only when no response at all. Unparseable responses return `success: true` with `messageTypeName: "UNPARSEABLE"`. Any parsed response with `messageType !== 0` is `success: true` — including RELEASE COMPLETE with rejection causes.

---

### `POST /api/h323/info` — Lightweight port probe

Connects to the target, sends a minimal SETUP with hardcoded numbers (`callingNumber='200'`, `calledNumber='100'`), reads one response. Returns connection timing and whether Q.931 was detected.

**POST body:**

| Field | Type | Default | Notes |
|---|---|---|---|
| `host` | string | *(required)* | |
| `port` | number | `1720` | |
| `timeout` | number | `10000` | Capped at 30000 ms |

**Response:**

```json
{
  "success": true,
  "host": "pbx.example.com",
  "port": 1720,
  "connectTime": 12,
  "rtt": 53,
  "protocol": "H.323/Q.931",
  "q931Detected": true,
  "messageType": 90,
  "messageTypeName": "RELEASE COMPLETE",
  "cause": { "value": 21, "description": "Call rejected" }
}
```

**`success`** is always `true` if the TCP connection opens, even if no Q.931 response is received. Check `q931Detected` to know if the port actually speaks H.323.

**`messageType`** is omitted (undefined) when `q931Detected` is `false`.

---

### `POST /api/h323/capabilities` — H.245 capability exchange

Sends H.245 TerminalCapabilitySet (TCS) and MasterSlaveDetermination (MSD) messages directly over TCP. Reads responses looking for TCSAck/TCSReject and MSDeterminationAck/MSDeterminationReject.

**POST body:**

| Field | Type | Default | Notes |
|---|---|---|---|
| `host` | string | *(required)* | |
| `port` | number | *(required)* | **No default — must be provided** |
| `timeout` | number | `10000` | Capped at **10000 ms** (not 30000) |

**Response:**

```json
{
  "success": true,
  "host": "pbx.example.com",
  "port": 1720,
  "tcsAckReceived": true,
  "msdAckReceived": true,
  "masterOrSlave": "slave",
  "rawResponseBytes": 42,
  "messages": [
    "Sent TerminalCapabilitySet (13 bytes, sequenceNumber=1)",
    "Sent MasterSlaveDetermination (6 bytes, terminalType=50)",
    "Received TerminalCapabilitySetAck",
    "Received MasterSlaveDeterminationAck (slave)"
  ],
  "rtt": 67
}
```

**`masterOrSlave`** is derived from the byte immediately following the MSD response CHOICE header: `0x00` → `"master"`, anything else → `"slave"`.

**`tcsAckReceived`** is set to `true` for both TCSAck *and* TCSReject — it means "the remote answered".

---

## Wire Protocol Details

### Q.931 SETUP Message (sent by /connect, /register, /info)

```
[Protocol Discriminator: 0x08]
[Call Ref Length: 0x02]
[Call Ref: 2 bytes, random 1–0x7FFF, bit 7 = 0 (originator)]
[Message Type: 0x05 (SETUP)]
[Bearer Capability IE: 0x04, 3 bytes, speech/64kbps/H.221]
[Display IE: 0x28, "Probe from {callingNumber}"]
[Called Party Number IE: 0x70, type=unknown/plan=unknown]
[Calling Party Number IE: 0x6C, type=unknown, screening=user-provided]
[User-User IE: 0x7E, H.225 v4 OID stub (9 bytes)]
```

**No TPKT framing.** Per RFC 1006 / ITU-T H.225.0 Annex E, H.225 call signaling over TCP should be wrapped in TPKT (4-byte header: version=3, reserved=0, 2-byte length). This implementation sends raw Q.931 directly. Spec-compliant H.323 endpoints expecting TPKT framing may reject or misparse the SETUP. Many older/lenient implementations accept raw Q.931.

### Q.931 RELEASE COMPLETE (sent by /connect on cleanup)

```
[0x08] [0x02] [callRef | 0x80 (response flag)] [0x5A]
[Cause IE: 0x08, 2 bytes, ITU-T/user, cause 16 (Normal call clearing)]
```

### H.245 TerminalCapabilitySet (sent by /capabilities)

```
[0x00 = request] [0x02 = TCS]
[sequenceNumber: 1]
[OID: 0x06 0x04 0x00 0x08 0xF5 0x00 (H.245 v13)]
[h2250Capability: 0x00]
[capabilityTable: 0 entries]
[capabilityDescriptors: 0 entries]
```

This is a **minimal approximation** of ASN.1 PER encoding. It advertises "we exist" with zero codec capabilities. Standards-compliant H.245 implementations may reject or misparse these bytes since they aren't valid PER.

### H.245 MasterSlaveDetermination (sent by /capabilities)

```
[0x00 = request] [0x00 = MSD]
[terminalType: 50 (terminal)]
[statusDeterminationNumber: 0x12 0x34 0x56 (hardcoded)]
```

**`statusDeterminationNumber` is hardcoded** to `0x123456`, not random. Per H.245 §8.2, this should be a random 24-bit value for proper master/slave arbitration.

### H.245 Response Scanning

The /capabilities handler scans every consecutive byte pair `(chunk[i], chunk[i+1])` looking for:

| outer (chunk[i]) | inner (chunk[i+1]) | Meaning |
|---|---|---|
| `0x01` | `0x00` | MasterSlaveDeterminationAck |
| `0x01` | `0x01` | MasterSlaveDeterminationReject |
| `0x01` | `0x02` | TerminalCapabilitySetAck |
| `0x01` | `0x03` | TerminalCapabilitySetReject |

This linear scan can produce false positives if data bytes happen to match these patterns.

---

## Q.931 Message Types

| Code | Name | Final? |
|---|---|---|
| `0x01` | ALERTING | No |
| `0x02` | CALL PROCEEDING | No |
| `0x03` | PROGRESS | No |
| `0x05` | SETUP | — |
| `0x07` | CONNECT | Yes |
| `0x5A` | RELEASE COMPLETE | Yes |
| `0x62` | FACILITY | No |
| `0x7D` | STATUS | Yes |

## Q.931 Cause Values (subset decoded)

| Code | Description |
|---|---|
| 1 | Unallocated number |
| 16 | Normal call clearing |
| 17 | User busy |
| 18 | No user responding |
| 21 | Call rejected |
| 27 | Destination out of order |
| 31 | Normal, unspecified |
| 34 | No circuit/channel available |
| 41 | Temporary failure |
| 47 | Resource unavailable, unspecified |
| 88 | Incompatible destination |
| 96 | Mandatory IE missing |
| 111 | Protocol error, unspecified |
| 127 | Interworking, unspecified |

Full table: 26 entries in code. Unknown codes return `"Cause {n}"`.

## Information Elements Recognized

| IE ID | Name | Parsed? |
|---|---|---|
| `0x04` | Bearer Capability | Listed only |
| `0x08` | Cause | Value + description extracted |
| `0x14` | Call State | Listed only |
| `0x1C` | Facility | Listed only |
| `0x1E` | Progress Indicator | Listed only |
| `0x27` | Notification Indicator | Listed only |
| `0x28` | Display | Text extracted |
| `0x34` | Signal | Listed only |
| `0x4C` | Connected Number | Text extracted (offset 1) |
| `0x6C` | Calling Party Number | Listed only |
| `0x70` | Called Party Number | Listed only |
| `0x7E` | User-User | H.225 version extracted |

Single-octet IEs (`0x90–0x9F` Sending Complete, `0xA0–0xAF` Congestion Level, `0xB0–0xBF` Repeat Indicator) are skipped.

---

## Cross-Endpoint Comparison

| Aspect | /connect | /register | /info | /capabilities |
|---|---|---|---|---|
| Default callingNumber | `"1000"` | `"200"` | hardcoded `"200"` | N/A |
| Default calledNumber | `"2000"` | `"100"` | hardcoded `"100"` | N/A |
| Default port | 1720 | 1720 | 1720 | **none (required)** |
| Timeout ceiling | 30000 ms | 30000 ms | 30000 ms | **10000 ms** |
| Default operator | `\|\|` (falsy) | `??` (nullish) | `??` (nullish) | N/A |
| Phone validation | regex | regex | none (hardcoded) | N/A |
| Response reads | multi-message loop | single read | single read | multi-read loop |
| success=true when | always (TCP connected) | messageType ≠ 0 | always (TCP connected) | always (TCP connected) |
| Sends RELEASE COMPLETE | on CONNECT + on no-final | never | never | never |
| Method restriction | POST only (405) | POST only (405) | POST only (405) | any (no check) |
| Port validation | 1–65535 | 1–65535 | 1–65535 | none |
| callRef range | 1–0x7FFF | 1–0x7FFE | 1–0x7FFE | N/A |

---

## Known Quirks and Limitations

1. **No TPKT framing.** H.225 over TCP per ITU-T H.225.0 Annex E requires TPKT (RFC 1006) 4-byte framing headers. All three Q.931-sending endpoints (/connect, /register, /info) write raw Q.931 bytes without TPKT. Spec-compliant H.323 stacks (Opal, OpenH323) will reject the connection.

2. **H.245 sent on wrong port.** The /capabilities endpoint connects directly to the given host:port and sends H.245 PDUs. In a real H.323 call, H.245 runs on a separate dynamic TCP port negotiated during H.225 setup. Sending H.245 to port 1720 (Q.931 signaling) will be misinterpreted as a malformed Q.931 message.

3. **H.225 UUIE is a fixed stub.** The User-User IE contains 9 bytes approximating an H.225 v4 protocol identifier, but this is not valid ASN.1 PER-encoded Setup-UUIE. Real gatekeepers need a proper Setup-UUIE with conferenceID, conferenceGoal, callType, and sourceInfo.

4. **H.245 TCS/MSD are not valid PER.** The TerminalCapabilitySet and MasterSlaveDetermination messages approximate the ASN.1 PER encoding but are hand-constructed byte sequences, not standards-compliant. The TCS advertises zero codecs and zero capabilities.

5. **MSD statusDeterminationNumber is hardcoded** to `0x123456`. Per H.245 §8.2, this must be random for each session to properly resolve master/slave conflicts.

6. **Default operator divergence.** `/connect` uses `||` for defaults — so `timeout: 0` or `callingNumber: ""` silently becomes the default. `/register` and `/info` use `??` — only `null`/`undefined` trigger defaults; `0` and `""` are preserved.

7. **Single TCP read in /register.** Reads exactly one chunk from the socket. TCP fragmentation can split one Q.931 message across chunks, causing truncation. `/connect` loops with multiple reads; `/register` does not.

8. **`success: true` + error possible in /register.** An unparseable response returns `success: true, messageTypeName: "UNPARSEABLE", error: "Could not parse Q.931 response"`.

9. **No Cloudflare detection.** None of the four endpoints call `checkIfCloudflare()`.

10. **`readExact` exported but unused.** The helper function `readExact()` is exported from h323.ts but not called by any handler.

11. **callRef range off-by-one.** `/connect` generates `Math.floor(Math.random() * 0x7fff) + 1` → range 1–0x7FFF. `/register` and `/info` use `Math.floor(Math.random() * 0x7ffe) + 1` → range 1–0x7FFE. Functionally harmless but inconsistent.

12. **`protocolVersion` always `"H.323v4"` in /connect.** Hardcoded string regardless of what the remote actually negotiates.

13. **/capabilities has no method restriction.** Unlike the other three endpoints (which return 405 for non-POST), /capabilities accepts any HTTP method as long as the JSON body parses.

14. **/capabilities has no port validation.** Unlike the other three endpoints (which reject port < 1 or > 65535), /capabilities does not validate the port range.

---

## curl Examples

```bash
# Full call signaling probe
curl -X POST https://portofcall.example.com/api/h323/connect \
  -H 'Content-Type: application/json' \
  -d '{"host":"pbx.example.com","calledNumber":"100"}'

# Gatekeeper registration probe
curl -X POST https://portofcall.example.com/api/h323/register \
  -H 'Content-Type: application/json' \
  -d '{"host":"gk.example.com","calledNumber":"1234","callingNumber":"5678"}'

# Lightweight port probe
curl -X POST https://portofcall.example.com/api/h323/info \
  -H 'Content-Type: application/json' \
  -d '{"host":"pbx.example.com"}'

# H.245 capability exchange (port required, no default)
curl -X POST https://portofcall.example.com/api/h323/capabilities \
  -H 'Content-Type: application/json' \
  -d '{"host":"pbx.example.com","port":1720,"timeout":5000}'
```

---

## Local Testing

**GNU Gatekeeper (GnuGK):**
```bash
# Install
apt install gnugk  # Debian/Ubuntu

# Minimal config (gnugk.ini):
# [RoutedMode]
# GKRouted=1
# [Gatekeeper::Main]
# Fourtytwo=42

gnugk -c gnugk.ini
# Listens on port 1720 (Q.931 signaling)
```

**Opal/OpenH323:**
```bash
# simph323 (simple H.323 endpoint)
# Part of opal (Portable Windows Library + Opal VoIP)
apt install opal-utils
simph323 --listen 1720
```

Note: Both GnuGK and Opal expect TPKT framing on TCP. The raw Q.931 messages from Port of Call may be rejected. Lenient implementations or gateways that accept non-framed Q.931 will respond.
