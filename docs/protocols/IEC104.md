# IEC 60870-5-104 (IEC 104) -- Power-User Reference

**Port:** 2404 (TCP)
**Spec:** IEC 60870-5-104:2006 (transport profile over TCP), IEC 60870-5-101 (companion standard for ASDU definitions), IEC 60870-5-4 (data element definitions)
**Implementation:** `src/worker/iec104.ts`
**Endpoints:** 3 (`/api/iec104/probe`, `/api/iec104/read-data`, `/api/iec104/write`)

---

## Protocol Overview

IEC 60870-5-104 is the TCP/IP transport profile of the IEC 60870-5-101 telecontrol protocol. It is the dominant SCADA protocol used in electrical power grids, substations, and industrial process control across Europe and much of Asia. It carries the same ASDU (Application Service Data Unit) structures as IEC 101 but replaces the serial link layer with TCP on port 2404.

### Frame Architecture

Every IEC 104 message is an APDU (Application Protocol Data Unit) consisting of:

```
+--------+--------+-----+-----+-----+-----+------------------+
| 0x68   | Length  | CF0 | CF1 | CF2 | CF3 | ASDU (I only)    |
+--------+--------+-----+-----+-----+-----+------------------+
  start    APDU len  <-- control field -->   <-- optional -->
  byte     (4-253)
```

- **Start byte**: Always `0x68`
- **Length byte**: Number of bytes following this byte (min 4, max 253)
- **Control field**: 4 bytes that determine frame type and carry sequence numbers

### Frame Types

| Frame | Bit 0 | Bit 1 | Purpose | Has ASDU |
|-------|-------|-------|---------|----------|
| **I-frame** (Information) | 0 | 0 | Numbered data transfer | Yes |
| **S-frame** (Supervisory) | 0 | 1 | Acknowledge received I-frames | No |
| **U-frame** (Unnumbered) | 1 | 1 | Connection management | No |

Detection logic (applied to control field byte 0):
- U-frame: `(cf0 & 0x03) === 0x03`
- S-frame: `(cf0 & 0x03) === 0x02`
- I-frame: `(cf0 & 0x01) === 0x00` (after excluding S-frames by order of checks)

### Sequence Numbers

I-frames carry two 15-bit sequence numbers (range 0-32767):

| Field | Location | Meaning |
|-------|----------|---------|
| N(S) | Control bytes 0-1, bits 1-15 | Send sequence number |
| N(R) | Control bytes 2-3, bits 1-15 | Receive sequence number (acknowledgment) |

Extraction: `N(S) = ((cf1 << 8) | cf0) >> 1`, `N(R) = ((cf3 << 8) | cf2) >> 1`

S-frames carry only N(R) in control bytes 2-3 (bytes 0-1 are `0x01 0x00`).

### U-Frame Commands

| Command | CF0 byte | Full frame (hex) |
|---------|----------|------------------|
| STARTDT Act | `0x07` | `68 04 07 00 00 00` |
| STARTDT Con | `0x0B` | `68 04 0B 00 00 00` |
| STOPDT Act | `0x13` | `68 04 13 00 00 00` |
| STOPDT Con | `0x23` | `68 04 23 00 00 00` |
| TESTFR Act | `0x43` | `68 04 43 00 00 00` |
| TESTFR Con | `0x83` | `68 04 83 00 00 00` |

All U-frames are exactly 6 bytes (length byte = 0x04).

---

## Endpoints

### `POST /api/iec104/probe` -- STARTDT + TESTFR probe

Sends STARTDT Act, waits for STARTDT Con, then sends TESTFR Act and waits for TESTFR Con. Finishes with STOPDT Act. This is the lightest-weight IEC 104 connectivity test -- it only uses U-frames and never enters the data transfer state.

**Request:**

```json
{
  "host": "192.168.1.100",
  "port": 2404,
  "timeout": 10000
}
```

| Field | Required | Default | Notes |
|-------|----------|---------|-------|
| `host` | yes | -- | Target hostname or IP |
| `port` | no | `2404` | Target port (validated 1-65535) |
| `timeout` | no | `10000` | Overall timeout in milliseconds |

**Success response:**

```json
{
  "success": true,
  "host": "192.168.1.100",
  "port": 2404,
  "rtt": 23,
  "startdtConfirmed": true,
  "testfrConfirmed": true,
  "framesReceived": [
    {
      "type": "U-frame",
      "length": 6,
      "controlField": "0x0b 0x00 0x00 0x00",
      "description": "STARTDT Con (Start Data Transfer Confirmation)"
    },
    {
      "type": "U-frame",
      "length": 6,
      "controlField": "0x83 0x00 0x00 0x00",
      "description": "TESTFR Con (Test Frame Confirmation)"
    }
  ]
}
```

**Wire exchange:**

```
Client --> Server:  68 04 07 00 00 00   (STARTDT Act)
Server --> Client:  68 04 0B 00 00 00   (STARTDT Con)
Client --> Server:  68 04 43 00 00 00   (TESTFR Act)
Server --> Client:  68 04 83 00 00 00   (TESTFR Con)
Client --> Server:  68 04 13 00 00 00   (STOPDT Act)
[close]
```

Each U-frame read uses a 5-second sub-timeout. The `framesReceived` array is capped at 20 entries.

---

### `POST /api/iec104/read-data` -- General Interrogation

Activates data transfer, sends a C_IC_NA_1 (Type 100) General Interrogation command, and collects all responding I-frames for up to 2 seconds. Parses each ASDU into structured objects with value, quality flags, and optional timestamp.

**Request:**

```json
{
  "host": "192.168.1.100",
  "port": 2404,
  "timeout": 15000,
  "commonAddress": 1
}
```

| Field | Required | Default | Notes |
|-------|----------|---------|-------|
| `host` | yes | -- | Target hostname or IP |
| `port` | no | `2404` | Target port (validated 1-65535) |
| `timeout` | no | `15000` | Overall timeout in milliseconds |
| `commonAddress` | no | `1` | ASDU Common Address (station address) |

**Success response:**

```json
{
  "success": true,
  "host": "192.168.1.100",
  "port": 2404,
  "commonAddress": 1,
  "asdus": [
    {
      "typeId": 1,
      "typeName": "M_SP_NA_1 (Single Point)",
      "ca": 1,
      "ioa": 100,
      "value": true,
      "quality": 0,
      "qualityFlags": [],
      "raw": "01"
    },
    {
      "typeId": 13,
      "typeName": "M_ME_NC_1 (Short Float Measured Value)",
      "ca": 1,
      "ioa": 4001,
      "value": 230.45,
      "quality": 0,
      "qualityFlags": [],
      "raw": "66 a6 66 43 00"
    },
    {
      "typeId": 30,
      "typeName": "M_SP_TB_1 (Single Point w/CP56Time2a)",
      "ca": 1,
      "ioa": 200,
      "value": false,
      "quality": 0,
      "qualityFlags": [],
      "timestamp": "2026-02-17T14:30:22.500Z",
      "raw": "00 f4 01 1e 0e 11 02 1a"
    }
  ],
  "count": 3,
  "rtt": 245
}
```

**Wire exchange:**

```
Client --> Server:  68 04 07 00 00 00                     (STARTDT Act)
Server --> Client:  68 04 0B 00 00 00                     (STARTDT Con)
Client --> Server:  68 0E 00 00 00 00                     (I-frame: C_IC_NA_1)
                    64 01 06 00 01 00 00 00 00 14          (ASDU: GI, QOI=20)
Server --> Client:  68 XX ...                              (I-frames with ASDU data)
                    ... (up to 2 seconds of collection)
Client --> Server:  68 04 01 00 XX XX                     (S-frame: acknowledge)
Client --> Server:  68 04 13 00 00 00                     (STOPDT Act)
[close]
```

**General Interrogation ASDU (C_IC_NA_1):**

```
Type ID:  0x64 (100)
VSQ:      0x01 (1 object, SQ=0)
COT:      0x06 0x00 (Activation)
CA:       <commonAddress LE 2 bytes>
IOA:      0x00 0x00 0x00
QOI:      0x14 (20 = station interrogation)
```

The collection loop caps at 500 ASDU objects to prevent unbounded memory use.

---

### `POST /api/iec104/write` -- Single/Double Command

Sends a control command (C_SC_NA_1 or C_DC_NA_1) to an IEC 104 controlled station and waits for an Activation Confirmation (COT=7).

**Request:**

```json
{
  "host": "192.168.1.100",
  "port": 2404,
  "timeout": 15000,
  "commonAddress": 1,
  "ioa": 5001,
  "commandType": "single",
  "value": 1
}
```

| Field | Required | Default | Notes |
|-------|----------|---------|-------|
| `host` | yes | -- | Target hostname or IP |
| `port` | no | `2404` | Target port |
| `timeout` | no | `15000` | Overall timeout in milliseconds |
| `commonAddress` | no | `1` | ASDU Common Address |
| `ioa` | yes | -- | Information Object Address of the control point |
| `commandType` | no | `"single"` | `"single"` (Type 45) or `"double"` (Type 46) |
| `value` | yes | -- | Single: 0 (OFF) or 1 (ON). Double: 1 (OFF) or 2 (ON) |

**Success response:**

```json
{
  "success": true,
  "host": "192.168.1.100",
  "port": 2404,
  "commandType": "single",
  "ioa": 5001,
  "value": 1,
  "activationConfirmed": true,
  "ackTypeId": 45,
  "ackCot": 7,
  "rtt": 89
}
```

**Command ASDU layout (C_SC_NA_1, Type 45):**

```
Byte 0:  0x2D (45)           Type ID
Byte 1:  0x01                VSQ: 1 object, SQ=0
Byte 2:  0x06                COT low: Activation (6)
Byte 3:  0x00                COT high
Byte 4-5: <CA LE>            Common Address
Byte 6-8: <IOA LE 3 bytes>   Information Object Address
Byte 9:  <SCO>               Single Command Object
```

SCO byte for single commands: bit 0 = SCS (0=OFF, 1=ON), bit 7 = S/E (0=Execute, 1=Select), bits 2-6 = QU (qualifier, default 0).

DCO byte for double commands: bits 0-1 = DCS (1=OFF, 2=ON), same upper bits.

**Activation Confirmation (COT=7):** The server mirrors back the same Type ID and IOA with COT=7 to confirm the command was accepted. COT=47 (with negative confirm bit set) indicates rejection.

---

## ASDU Structure

All I-frames carry an ASDU with this header:

```
+----------+-----+---------+---------+-----------------------------+
| Type ID  | VSQ | COT     | CA      | Information Objects...      |
| (1 byte) | (1) | (2 LE)  | (2 LE)  | [IOA(3) + value + quality]  |
+----------+-----+---------+---------+-----------------------------+
```

**VSQ (Variable Structure Qualifier):**
- Bit 7 (SQ): 0 = each object has its own IOA, 1 = sequential IOAs (first IOA given, rest increment by 1)
- Bits 0-6: Number of information objects (0-127)

**COT (Cause of Transmission) -- common values:**

| COT | Meaning |
|-----|---------|
| 1 | Periodic/Cyclic |
| 2 | Background scan |
| 3 | Spontaneous |
| 5 | Request (by GI) |
| 6 | Activation |
| 7 | Activation Confirmation |
| 8 | Deactivation |
| 9 | Deactivation Confirmation |
| 10 | Activation Termination |
| 20 | Interrogated by station (GI response) |
| 44 | Unknown type ID |
| 45 | Unknown COT |
| 46 | Unknown CA |
| 47 | Unknown IOA |

**IOA (Information Object Address):** 3 bytes little-endian in IEC 104 (range 0-16777215).

**CA (Common Address):** 2 bytes little-endian in IEC 104 (range 0-65535). Typically 1 for single-station setups.

---

## Supported ASDU Types

### Monitor direction (server to client)

| Type | Name | Value | Quality | Timestamp | Object size |
|------|------|-------|---------|-----------|-------------|
| 1 | M_SP_NA_1 | Single point (bool) | SIQ byte upper nibble | -- | 1 byte |
| 2 | M_SP_TA_1 | Single point + CP24Time2a | SIQ byte upper nibble | 3-byte (not parsed) | 4 bytes |
| 3 | M_DP_NA_1 | Double point (0-3) | DIQ byte upper nibble | -- | 1 byte |
| 4 | M_DP_TA_1 | Double point + CP24Time2a | DIQ byte upper nibble | 3-byte (not parsed) | 4 bytes |
| 5 | M_ST_NA_1 | Step position (-64..+63) | Separate QDS byte | -- | 2 bytes |
| 9 | M_ME_NA_1 | Normalized (-1..+1) | Separate QDS byte | -- | 3 bytes |
| 11 | M_ME_NB_1 | Scaled (int16) | Separate QDS byte | -- | 3 bytes |
| 13 | M_ME_NC_1 | Short float (IEEE 754) | Separate QDS byte | -- | 5 bytes |
| 30 | M_SP_TB_1 | Single point + CP56Time2a | SIQ byte upper nibble | 7-byte parsed | 8 bytes |
| 31 | M_DP_TB_1 | Double point + CP56Time2a | DIQ byte upper nibble | 7-byte parsed | 8 bytes |
| 36 | M_ME_TD_1 | Normalized + CP56Time2a | Separate QDS byte | 7-byte parsed | 10 bytes |
| 37 | M_ME_TE_1 | Scaled + CP56Time2a | Separate QDS byte | 7-byte parsed | 10 bytes |
| 38 | M_ME_TF_1 | Short float + CP56Time2a | Separate QDS byte | 7-byte parsed | 12 bytes |

### Command direction (client to server)

| Type | Name | Notes |
|------|------|-------|
| 45 | C_SC_NA_1 | Single command (via `/write`) |
| 46 | C_DC_NA_1 | Double command (via `/write`) |
| 100 | C_IC_NA_1 | General Interrogation (via `/read-data`) |

Types not in this table are classified as `Type N` and skip the information object bytes to avoid infinite loops.

---

## Quality Descriptor (QDS)

Per IEC 60870-5-4 Section 6.3, the separate quality descriptor byte uses these bit positions:

| Bit | Mask | Flag | Meaning |
|-----|------|------|---------|
| 0 | 0x01 | OV | Overflow |
| 1-3 | -- | -- | Reserved |
| 4 | 0x10 | BL | Blocked |
| 5 | 0x20 | SB | Substituted |
| 6 | 0x40 | NT | Not Topical |
| 7 | 0x80 | IV | Invalid |

For combined SIQ/DIQ bytes (Types 1, 2, 3, 4, 30, 31), quality is in the upper nibble (bits 4-7 only: BL, SB, NT, IV). The implementation extracts this with `& 0xF0`.

---

## CP56Time2a Timestamp

7-byte timestamp structure per IEC 60870-5-4 Section 6.8:

| Bytes | Bits | Field | Range |
|-------|------|-------|-------|
| 0-1 | uint16 LE | Milliseconds within minute | 0-59999 |
| 2 | 0-5 | Minutes | 0-59 |
| 2 | 7 | IV (invalid time) | 0-1 |
| 3 | 0-4 | Hours | 0-23 |
| 3 | 7 | SU (summer time) | 0-1 |
| 4 | 0-4 | Day of month | 1-31 |
| 4 | 5-7 | Day of week | 1-7 (Mon=1) |
| 5 | 0-3 | Month | 1-12 |
| 6 | 0-6 | Year (offset from 2000) | 0-99 |

Seconds and sub-second milliseconds are derived from the milliseconds-within-minute field:
- `seconds = floor(msInMinute / 1000)`
- `milliseconds = msInMinute % 1000`

The IV and SU flags in the minute/hour bytes are not currently extracted into the response -- they are masked off during parsing.

---

## Quirks and Limitations

### STARTDT is always required

Both `/read-data` and `/write` send STARTDT Act and require STARTDT Con before proceeding. If the server does not confirm STARTDT within 5 seconds, the operation fails. The `/probe` endpoint also sends STARTDT Act but reports `startdtConfirmed: false` rather than failing.

### No select-before-execute

The `/write` endpoint always sends commands with S/E bit = 0 (Execute). The IEC 104 select-before-execute pattern (send with S/E=1 first, wait for confirmation, then send with S/E=0) is not implemented. Some RTUs require SBO and will reject direct execute commands.

### No time-tagged command types

Only C_SC_NA_1 (Type 45) and C_DC_NA_1 (Type 46) are supported. The time-tagged variants C_SC_TA_1 (Type 58) and C_DC_TA_1 (Type 59) are not available.

### No counter interrogation

C_CI_NA_1 (Type 101) is listed in the type name table but is not sent by any endpoint. Only C_IC_NA_1 (Type 100) General Interrogation is used.

### Fixed collection window

The `/read-data` endpoint collects I-frames for a fixed 2-second window after sending the GI command. Servers with many data points may not finish responding within 2 seconds, resulting in incomplete data. There is no detection of the Activation Termination (COT=10) that signals GI completion.

### No periodic S-frame acknowledgment

During the `/read-data` collection phase, no S-frames are sent until after collection completes. The IEC 104 standard specifies a maximum number of unacknowledged I-frames (parameter `w`, default 8) before the server should close the connection. Fast-responding servers with many data points may hit this limit.

### ASDU collection cap

The `/read-data` endpoint caps at 500 parsed ASDU information objects. The `/probe` endpoint caps at 20 frame entries.

### CP24Time2a not parsed

Type 2 (M_SP_TA_1) and Type 4 (M_DP_TA_1) use the older 3-byte CP24Time2a timestamp. The bytes are consumed (offset advances) but no timestamp is extracted into the response.

### Unknown ASDU types consume all remaining bytes

If the ASDU parser encounters an unrecognized type ID, it sets `offset = asduData.length` to break the loop. This means if multiple objects exist in the ASDU, only the first is parsed before abandoning the rest. This is necessary because object size is type-dependent.

### Cloudflare detection

All three endpoints check `checkIfCloudflare(host)` before connecting. Returns HTTP 403 with `isCloudflare: true` if the host resolves to a Cloudflare IP. This prevents accidental probing of Cloudflare infrastructure.

### Port validation

All endpoints validate port is between 1 and 65535. Invalid ports return HTTP 400.

### No TLS support

IEC 104 traditionally runs over plain TCP. The IEC 62351 standard defines TLS for IEC 104, but this implementation does not support it.

---

## curl Examples

```bash
# Basic connectivity probe (STARTDT + TESTFR)
curl -s -X POST https://portofcall.tshark.dev/api/iec104/probe \
  -H 'Content-Type: application/json' \
  -d '{"host":"192.168.1.100"}' | jq

# Probe on non-standard port
curl -s -X POST https://portofcall.tshark.dev/api/iec104/probe \
  -H 'Content-Type: application/json' \
  -d '{"host":"10.0.0.50","port":2405,"timeout":5000}' | jq

# Read all data via General Interrogation
curl -s -X POST https://portofcall.tshark.dev/api/iec104/read-data \
  -H 'Content-Type: application/json' \
  -d '{"host":"192.168.1.100","commonAddress":1}' | jq

# Read from station address 3
curl -s -X POST https://portofcall.tshark.dev/api/iec104/read-data \
  -H 'Content-Type: application/json' \
  -d '{"host":"192.168.1.100","commonAddress":3}' | jq

# Send single command ON to IOA 5001
curl -s -X POST https://portofcall.tshark.dev/api/iec104/write \
  -H 'Content-Type: application/json' \
  -d '{"host":"192.168.1.100","ioa":5001,"commandType":"single","value":1}' | jq

# Send double command OFF to IOA 6002
curl -s -X POST https://portofcall.tshark.dev/api/iec104/write \
  -H 'Content-Type: application/json' \
  -d '{"host":"192.168.1.100","ioa":6002,"commandType":"double","value":1}' | jq
```

---

## Local Testing

```bash
# Run an IEC 104 simulator (e.g., FreyrSCADA or OpenMUC j60870)
# Example with docker (if a suitable image is available):
docker run -d --name iec104sim -p 2404:2404 <iec104-simulator-image>

# Test probe
curl -s -X POST http://localhost:8787/api/iec104/probe \
  -d '{"host":"host.docker.internal","port":2404}' | jq

# Test read-data
curl -s -X POST http://localhost:8787/api/iec104/read-data \
  -d '{"host":"host.docker.internal"}' | jq
```

---

## Per-Endpoint Quick Reference

| | `/probe` | `/read-data` | `/write` |
|---|---|---|---|
| Method | POST only | POST only | POST only |
| Default port | 2404 | 2404 | 2404 |
| Default timeout | 10,000 ms | 15,000 ms | 15,000 ms |
| CF detection | yes | yes | yes |
| Port validation | yes (1-65535) | yes (1-65535) | yes (1-65535) |
| STARTDT required | sent, not required | required | required |
| Sends I-frames | no | 1 (GI command) | 1 (command) |
| Parses ASDUs | no | yes (up to 500) | yes (ACK only) |
| S-frame ack | no | yes (after collection) | yes (after ACK) |
| STOPDT on close | yes | yes | yes |
| success criteria | TCP connected | STARTDT confirmed + GI sent | STARTDT confirmed |
