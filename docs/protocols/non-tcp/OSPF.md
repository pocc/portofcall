# ⚠️ NON-TCP PROTOCOL - NOT COMPATIBLE WITH CLOUDFLARE WORKERS

> **Note:** This protocol does not use TCP as its primary transport mechanism. It cannot be implemented using Cloudflare Workers' Sockets API (`connect()`), which only supports TCP connections. This protocol is documented here for reference but requires alternative implementation approaches (native UDP/IP sockets, specialized gateways, or protocol translation).


## Overview

**OSPF (Open Shortest Path First)** is a link-state routing protocol used within autonomous systems (AS) to determine the best path for packet forwarding. OSPF is widely deployed in enterprise and service provider networks, offering fast convergence, hierarchical design, and support for VLSM and CIDR.

**Port:** IP Protocol 89 (not TCP/UDP)
**Transport:** Raw IP packets
**Status:** Active standard
**RFC:** 2328 (OSPFv2 for IPv4), 5340 (OSPFv3 for IPv6)

## Protocol Specification

### Key Features

1. **Link-State Protocol**: Each router knows complete network topology
2. **Dijkstra's Algorithm**: SPF (Shortest Path First) calculation
3. **Fast Convergence**: Rapid response to topology changes
4. **Hierarchical Design**: Areas for scalability
5. **VLSM/CIDR Support**: Variable-length subnet masks
6. **Load Balancing**: Equal-cost multipath (ECMP)
7. **Authentication**: MD5, SHA authentication
8. **Multicast Updates**: Reduces unnecessary traffic

### OSPF Packet Types

- `1` - Hello (neighbor discovery, keepalive)
- `2` - Database Description (DBD) - Topology summary
- `3` - Link State Request (LSR) - Request missing LSAs
- `4` - Link State Update (LSU) - Contains LSAs
- `5` - Link State Acknowledgment (LSAck) - Confirm LSU receipt

### OSPF Packet Header

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|   Version #   |     Type      |         Packet length         |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                          Router ID                            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                           Area ID                             |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|           Checksum            |             AuType            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                       Authentication                          |
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

### Hello Protocol

**Hello Packet Fields:**
- Network Mask
- Hello Interval (default 10 seconds)
- Router Dead Interval (default 40 seconds)
- Router Priority (for DR election)
- Designated Router (DR)
- Backup Designated Router (BDR)
- Neighbor List

**Neighbor States:**
- **Down**: No communication
- **Init**: Hello received
- **2-Way**: Bidirectional communication
- **ExStart**: Master/slave negotiation
- **Exchange**: DBD exchange
- **Loading**: LSR/LSU exchange
- **Full**: Adjacency complete

### Router Types

**Internal Router:**
- All interfaces in same area

**Area Border Router (ABR):**
- Connects multiple areas
- Maintains separate LSDB per area

**Autonomous System Boundary Router (ASBR):**
- Injects external routes (BGP, static, etc.)
- Generates Type-5 LSAs

**Backbone Router:**
- Has interface in Area 0

### Areas

**Area 0 (Backbone):**
- Required
- All other areas must connect to Area 0
- Transit area for inter-area traffic

**Stub Area:**
- No external routes (Type-5 LSAs)
- Default route from ABR

**Totally Stubby Area:**
- No external or inter-area routes
- Cisco proprietary

**Not-So-Stubby Area (NSSA):**
- Allows limited external routes (Type-7 LSAs)
- Useful for branch offices

### LSA Types

**Type-1 (Router LSA):**
- Generated by every router
- Describes router's links within area
- Flooded within area only

**Type-2 (Network LSA):**
- Generated by DR
- Describes multi-access network
- Flooded within area only

**Type-3 (Summary LSA):**
- Generated by ABR
- Describes inter-area routes
- Flooded into area

**Type-4 (ASBR Summary LSA):**
- Generated by ABR
- Describes path to ASBR
- Flooded into area

**Type-5 (AS External LSA):**
- Generated by ASBR
- Describes external routes
- Flooded throughout AS (except stubs)

**Type-7 (NSSA External LSA):**
- Generated by ASBR in NSSA
- Converted to Type-5 by ABR
- Flooded within NSSA only

### Designated Router (DR)

**Purpose:**
- Reduces adjacencies on multi-access networks
- All routers form adjacency with DR/BDR
- DR generates Network LSA (Type-2)

**Election:**
- Highest priority (default 1)
- If tied, highest Router ID
- Priority 0 = never DR/BDR

**Benefits:**
- Reduces LSA flooding
- n routers: Without DR = n(n-1)/2 adjacencies, With DR = n-1 adjacencies

### Metrics

**Cost Calculation:**
```
Cost = Reference Bandwidth / Interface Bandwidth

Default Reference: 100 Mbps
10 Mbps Ethernet: 100/10 = 10
100 Mbps Fast Ethernet: 100/100 = 1
1 Gbps Gigabit: 100/1000 = 1 (minimum)
10 Gbps: 100/10000 = 1 (minimum)
```

**Path Cost:**
- Sum of costs along path
- Lowest cost = best path

**ECMP:**
- Multiple equal-cost paths
- Load balancing across paths

### Authentication

**Null (Type 0):**
- No authentication

**Simple Password (Type 1):**
- Plain-text password
- Insecure, deprecated

**MD5 (Type 2):**
- MD5 hash authentication
- Key ID for key rotation

**SHA (OSPFv3):**
- SHA-256, SHA-384, SHA-512
- IPsec can also be used

### Multicast Addresses

**AllSPFRouters:**
- `224.0.0.5` (IPv4)
- `FF02::5` (IPv6)
- All OSPF routers listen

**AllDRouters:**
- `224.0.0.6` (IPv4)
- `FF02::6` (IPv6)
- DR and BDR listen

## Configuration Examples

**Cisco IOS:**
```
# Enable OSPF
router ospf 1
 router-id 1.1.1.1
 network 10.0.0.0 0.255.255.255 area 0
 network 192.168.1.0 0.0.0.255 area 1
 passive-interface Loopback0

# Area configuration
 area 1 stub
 area 2 nssa

# Authentication
interface GigabitEthernet0/0
 ip ospf authentication message-digest
 ip ospf message-digest-key 1 md5 MySecret

# Cost adjustment
interface GigabitEthernet0/1
 ip ospf cost 10

# DR priority
interface GigabitEthernet0/0
 ip ospf priority 100
```

**Juniper JunOS:**
```
protocols {
    ospf {
        area 0.0.0.0 {
            interface ge-0/0/0.0;
            interface ge-0/0/1.0 {
                priority 200;
            }
        }
        area 0.0.0.1 {
            stub;
            interface ge-0/0/2.0;
        }
    }
}
```

## Resources

- **RFC 2328**: OSPF Version 2
- **RFC 5340**: OSPF for IPv6 (OSPFv3)
- **RFC 3101**: The OSPF Not-So-Stubby Area (NSSA) Option
- **RFC 5709**: OSPFv2 HMAC-SHA Cryptographic Authentication
- [OSPF Design Guide](https://www.cisco.com/c/en/us/support/docs/ip/open-shortest-path-first-ospf/7039-1.html)

## Notes

- **vs RIP**: OSPF converges faster, scales better, uses bandwidth not hops
- **vs EIGRP**: EIGRP is Cisco proprietary, OSPF is open standard
- **vs BGP**: OSPF is IGP (intra-AS), BGP is EGP (inter-AS)
- **vs IS-IS**: Similar link-state protocol, IS-IS is OSI-based
- **Link-State**: Complete topology knowledge vs distance-vector
- **SPF Algorithm**: Dijkstra's shortest path tree calculation
- **Area 0**: Backbone area, mandatory
- **ABR**: Connects areas, summarization point
- **ASBR**: Redistributes external routes
- **DR/BDR**: Reduces adjacencies on broadcast networks
- **LSA Flooding**: Link-state advertisements propagate changes
- **Convergence**: Fast (seconds) compared to RIP (minutes)
- **VLSM**: Full support for variable-length subnet masks
- **Route Summarization**: Manual at ABR/ASBR boundaries
- **Default Route**: Inject with `default-information originate`
- **Passive Interface**: Advertise network but don't send Hellos
- **Virtual Link**: Connect area to Area 0 through another area
- **MTU Mismatch**: Can prevent adjacency formation
- **Network Types**: Broadcast, Point-to-Point, NBMA, Point-to-Multipoint
- **Scalability**: Areas limit LSDB size, improve scalability
